<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HexaShop — профиль</title>
<style>
:root{--bg:#0b0f14;--panel:#11161f;--text:#e7e9ee;--muted:#9aa3b2;--stroke:rgba(255,255,255,.12);--ring:#3b82f6;--radius:16px}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid var(--stroke)}
.brand{font-weight:900}.actions{display:flex;gap:8px}.btn{appearance:none;border:1px solid var(--stroke);background:#1b2436;color:#fff;border-radius:999px;padding:9px 14px;cursor:pointer;font-weight:700}
main{max-width:860px;margin:0 auto;padding:14px 18px 40px}
.card{background:var(--panel);border:1px solid var(--stroke);border-radius:var(--radius);padding:16px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
label{font-size:.9rem;color:var(--muted)}
input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);background:#0f141f;color:#e7e9ee;outline:none}
input:focus{border-color:var(--ring);box-shadow:0 0 0 3px color-mix(in oklab, var(--ring) 35%, transparent)}
.kv{display:grid;grid-template-columns:160px 1fr;gap:8px;color:var(--muted);margin-top:6px}.ok{color:#9ae6b4}.err{color:#fda4af}
</style>
<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="/accounts.js"></script>
</head>
<body>
<header>
  <div class="brand">HexaShop</div>
  <div class="actions" id="hdrActions">
    <a class="btn" href="index.html">Каталог</a>
    <a class="btn" id="authLink" href="auth.html">Войти</a>
  </div>
</header>

<main>
  <a href="index.html" class="btn">← Назад</a>
  <div class="card" style="margin-top:12px">
    <h1 style="margin:0 0 10px">Мой профиль</h1>
    <div class="kv"><div>E-mail</div><div id="email">—</div></div>
    <div class="kv"><div>User ID</div><div id="uid">—</div></div>
    <form id="form" style="display:grid;gap:12px;margin-top:12px">
      <div class="row">
        <div><label>Никнейм (a-z, 0-9, _; 3–20)</label><input id="username" pattern="^[a-z0-9_]{3,20}$" /></div>
        <div><label>Отображаемое имя</label><input id="display_name" /></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" type="submit">Сохранить</button>
        <span id="msg" class="muted"></span>
      </div>
    </form>
  </div>
</main>

<script>
const SUPABASE_URL="https://noxovxsvexezcomxqejk.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5veG92eHN2ZXhlemNvbXhxZWprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNzQ5MzIsImV4cCI6MjA3Njk1MDkzMn0.r7OuZFhNuLYYVbLcorjIJ3UHPRPeqlOMH2H7nXdk69g";
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
Accounts.mountHeaderAuth(sb, 'delete.html');
async function ensureProfileIfMissing(sb){const {data:{session}}=await sb.auth.getSession();const u=session?.user;if(!u)return;const {data:pr}=await sb.from('profiles').select('id').eq('id',u.id).maybeSingle();if(!pr){try{await sb.rpc('upsert_my_profile',{p_username:u.user_metadata?.username||'',p_display_name:u.user_metadata?.full_name||u.email||''});}catch(e){}}}
async function mountHeaderAuth(sb){const btn=document.getElementById('authBtn'),actions=document.getElementById('hdrActions');if(!btn)return;await ensureProfileIfMissing(sb);const {data:{session}}=await sb.auth.getSession();const user=session?.user;const old=actions.querySelector('button[data-logout]');if(old)old.remove();if(user){btn.textContent='Профиль';btn.onclick=()=>location.href='profile.html';const o=document.createElement('button');o.className='btn';o.dataset.logout='1';o.textContent='Выйти';o.onclick=async()=>{await sb.auth.signOut();location.reload();};actions.appendChild(o);}else{btn.textContent='Войти';btn.onclick=()=>{localStorage.setItem('postLoginRedirect','profile.html');location.href='auth.html';};}}
mountHeaderAuth(sb);

const emailEl=document.getElementById('email'), uidEl=document.getElementById('uid'), fUser=document.getElementById('username'), fName=document.getElementById('display_name'), msg=document.getElementById('msg'), form=document.getElementById('form');

(async function init(){
  const {data:{user}}=await sb.auth.getUser();
  if(!user){localStorage.setItem('postLoginRedirect','profile.html'); location.href='auth.html'; return;}
  emailEl.textContent=user.email||'—'; uidEl.textContent=user.id;
  const {data:p}=await sb.from('profiles').select('username,display_name').eq('id',user.id).maybeSingle();
  fUser.value=p?.username||''; fName.value=p?.display_name||user.email||'';
  form.addEventListener('submit',async e=>{e.preventDefault(); msg.textContent='';
    const username=fUser.value.trim(), display=fName.value.trim();
    if(username && !/^[a-z0-9_]{3,20}$/.test(username)){msg.className='err'; msg.textContent='Ник: a-z, 0-9, _, 3–20'; return;}
    const {error}=await sb.rpc('upsert_my_profile',{p_username:username,p_display_name:display});
    if(error){msg.className='err'; msg.textContent=error.message; return;} msg.className='ok'; msg.textContent='Сохранено';
  });
})();
</script>
</body>
</html>


