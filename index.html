<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HexaShop — каталог</title>
<style>
:root{--bg:#0b0f14;--panel:#11161f;--text:#e7e9ee;--muted:#9aa3b2;--stroke:rgba(255,255,255,.12);--ring:#3b82f6;--radius:16px;--shadow:0 8px 30px rgba(0,0,0,.35)}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
header{position:sticky;top:0;z-index:10;display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid var(--stroke);backdrop-filter:saturate(1.1) blur(6px);background:color-mix(in oklab, var(--bg) 92%, transparent)}
.brand{font-weight:900}.actions{display:flex;gap:8px}
.btn{appearance:none;border:1px solid var(--stroke);background:#1b2436;color:#fff;border-radius:999px;padding:9px 14px;cursor:pointer;font-weight:700}
a.btn{display:inline-block;text-decoration:none}
main{max-width:1200px;margin:0 auto;padding:14px 18px 40px}
.search{display:flex;gap:8px;margin:8px 0 14px}
input{flex:1;min-width:220px;padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);background:#0f141f;color:#e7e9ee;outline:none}
input:focus{border-color:var(--ring);box-shadow:0 0 0 3px color-mix(in oklab, var(--ring) 35%, transparent)}
#grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px}
.card{display:block;background:var(--panel);border:1px solid var(--stroke);border-radius:var(--radius);overflow:hidden;color:var(--text);text-decoration:none;box-shadow:var(--shadow);transition:transform .12s}
.card:hover{transform:translateY(-2px)}
.thumb{aspect-ratio:16/10;background:#0f141f center/cover no-repeat}
.body{padding:12px}.title{font-weight:800;line-height:1.25;min-height:40px}
.desc{color:var(--muted);font-size:.92rem;line-height:1.4;min-height:40px;margin-top:4px}
.price{margin-top:8px;font-weight:900}.empty{opacity:.7;margin-top:10px}.muted{color:var(--muted)}
</style>
<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="/accounts.js"></script>
</head>
<body>
<header>
  <div class="brand">HexaShop</div>
  <div class="actions" id="hdrActions">
    <a class="btn" href="sell.html">Sell</a>
    <a class="btn" href="delete.html">Мои товары</a>
    <a class="btn" id="authLink" href="auth.html">Войти</a>
  </div>
</header>

<main>
  <div class="search">
    <input id="q" type="search" placeholder="Поиск по названию или описанию…" />
    <button class="btn" id="reset">Сброс</button>
  </div>
  <div id="grid"></div>
  <div id="empty" class="empty" style="display:none">Ничего не найдено.</div>
</main>

<script>
const SUPABASE_URL="https://noxovxsvexezcomxqejk.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5veG92eHN2ZXhlemNvbXhxZWprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNzQ5MzIsImV4cCI6MjA3Njk1MDkzMn0.r7OuZFhNuLYYVbLcorjIJ3UHPRPeqlOMH2H7nXdk69g";
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
Accounts.mountHeaderAuth(sb);

async function ensureProfileIfMissing(sb){
  const {data:{session}}=await sb.auth.getSession(); const user=session?.user; if(!user) return;
  const {data:pr}=await sb.from('profiles').select('id').eq('id',user.id).maybeSingle();
  if(!pr){ try{ await sb.rpc('upsert_my_profile',{p_username:user.user_metadata?.username||'',p_display_name:user.user_metadata?.full_name||user.email||''}); }catch(e){console.warn(e);} }
}
async function mountHeaderAuth(sb){
  const btn=document.getElementById('authBtn'); const actions=document.getElementById('hdrActions'); if(!btn||!actions) return;
  await ensureProfileIfMissing(sb);
  const {data:{session}}=await sb.auth.getSession(); const user=session?.user;
  const old=actions.querySelector('button[data-logout]'); if(old) old.remove();
  if(user){
    btn.textContent='Профиль'; btn.onclick=()=>location.href='profile.html';
    const out=document.createElement('button'); out.className='btn'; out.dataset.logout='1'; out.textContent='Выйти';
    out.onclick=async()=>{await sb.auth.signOut(); location.reload();}; actions.appendChild(out);
  }else{
    btn.textContent='Войти'; btn.onclick=()=>{localStorage.setItem('postLoginRedirect','index.html'); location.href='auth.html';};
  }
}
mountHeaderAuth(sb);

const grid=document.getElementById('grid'), empty=document.getElementById('empty'), q=document.getElementById('q');
document.getElementById('reset').onclick=()=>{q.value='';load();}; q.addEventListener('input',debounce(()=>load(q.value),250));

function price(c,cur='USD'){ if(c==null) return ''; const v=c/100; try{return new Intl.NumberFormat(cur==='RUB'?'ru-RU':'en-US',{style:'currency',currency:cur}).format(v);}catch{return v.toFixed(2)+' '+cur;}}
function escapeHtml(s=''){return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
function cardTpl(p,cover){const a=document.createElement('a');a.className='card';a.href=`product.html?id=${encodeURIComponent(p.id)}`;a.innerHTML=`<div class="thumb" style="background-image:url('${cover||''}')"></div><div class="body"><div class="title">${escapeHtml(p.title||'')}</div><div class="desc">${escapeHtml((p.description||'').slice(0,100))}</div><div class="price">${price(p.price_cents,p.currency)}</div></div>`;return a;}
function debounce(fn,t=250){let h;return(...a)=>{clearTimeout(h);h=setTimeout(()=>fn(...a),t)}}

async function load(filter=''){
  grid.innerHTML=''; empty.style.display='none';
  for(let i=0;i<6;i++){const s=document.createElement('div');s.className='card';s.innerHTML='<div class="thumb"></div><div class="body"><div class="title muted">Загрузка…</div></div>';grid.appendChild(s);}
  let query=sb.from('products').select('id,title,description,price_cents,currency').eq('status','published').order('id',{ascending:false}).limit(100);
  if(filter.trim()){const t=`%${filter.trim()}%`; query=sb.from('products').select('id,title,description,price_cents,currency').or(`title.ilike.${t},description.ilike.${t}`).eq('status','published').order('id',{ascending:false}).limit(100);}
  const {data:products,error}=await query; if(error){grid.innerHTML='<div class="muted">Ошибка загрузки</div>';return;}
  if(!products?.length){grid.innerHTML=''; empty.style.display='block'; return;}
  const ids=products.map(p=>p.id); const {data:files}=await sb.from('product_files').select('product_id,url,kind').in('product_id',ids).eq('kind','cover');
  const m=new Map((files||[]).map(f=>[f.product_id,f.url])); grid.innerHTML=''; products.forEach(p=>grid.appendChild(cardTpl(p,m.get(p.id))));
}
load();
</script>
</body>
</html>


