<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HexaShop — товар</title>
<style>
:root{--bg:#0b0f14;--panel:#11161f;--text:#e7e9ee;--muted:#9aa3b2;--stroke:rgba(255,255,255,.12);--ring:#3b82f6;--radius:16px;--shadow:0 8px 30px rgba(0,0,0,.35)}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid var(--stroke)}
.brand{font-weight:900}.actions{display:flex;gap:8px}.btn{appearance:none;border:1px solid var(--stroke);background:#1b2436;color:#fff;border-radius:999px;padding:9px 14px;cursor:pointer;font-weight:700}
main{max-width:1000px;margin:0 auto;padding:14px 18px 40px}
.grid{display:grid;grid-template-columns:1.15fr 1fr;gap:16px}
.panel{background:var(--panel);border:1px solid var(--stroke);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow)}
.thumb{aspect-ratio:16/10;background:#0f141f center/cover no-repeat}
h1{margin:0 0 6px}.muted{color:var(--muted)}
</style>
<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="/accounts.js"></script>
</head>
<body>
<header>
  <div class="brand">HexaShop</div>
  <div class="actions" id="hdrActions">
    <a class="btn" href="index.html">Каталог</a>
    <a class="btn" href="sell.html">Sell</a>
    <a class="btn" id="authLink" href="auth.html">Войти</a>
  </div>
</header>

<main>
  <a href="index.html" class="btn">← Назад</a>
  <div id="box" class="grid" style="margin-top:12px"></div>
</main>

<script>
const SUPABASE_URL="https://noxovxsvexezcomxqejk.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5veG92eHN2ZXhlemNvbXhxZWprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNzQ5MzIsImV4cCI6MjA3Njk1MDkzMn0.r7OuZFhNuLYYVbLcorjIJ3UHPRPeqlOMH2H7nXdk69g";
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
Accounts.mountHeaderAuth(sb);
async function ensureProfileIfMissing(sb){const {data:{session}}=await sb.auth.getSession();const u=session?.user;if(!u)return;const {data:pr}=await sb.from('profiles').select('id').eq('id',u.id).maybeSingle();if(!pr){try{await sb.rpc('upsert_my_profile',{p_username:u.user_metadata?.username||'',p_display_name:u.user_metadata?.full_name||u.email||''});}catch(e){}}}
async function mountHeaderAuth(sb){const btn=document.getElementById('authBtn'),actions=document.getElementById('hdrActions');if(!btn)return;await ensureProfileIfMissing(sb);const {data:{session}}=await sb.auth.getSession();const user=session?.user;const old=actions.querySelector('button[data-logout]');if(old)old.remove();if(user){btn.textContent='Профиль';btn.onclick=()=>location.href='profile.html';const o=document.createElement('button');o.className='btn';o.dataset.logout='1';o.textContent='Выйти';o.onclick=async()=>{await sb.auth.signOut();location.reload();};actions.appendChild(o);}else{btn.textContent='Войти';btn.onclick=()=>{localStorage.setItem('postLoginRedirect',location.pathname.split('/').pop()||'index.html');location.href='auth.html';};}}
mountHeaderAuth(sb);

const id=new URLSearchParams(location.search).get('id'); const box=document.getElementById('box');
function escapeHtml(s=''){return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
function price(c,cur='USD'){if(c==null)return'';const v=c/100;try{return new Intl.NumberFormat(cur==='RUB'?'ru-RU':'en-US',{style:'currency',currency:cur}).format(v);}catch{return v.toFixed(2)+' '+cur;}}
(async function(){
  if(!id){box.innerHTML='<div class="muted">Не указан id товара</div>';return;}
  const {data:p,error}=await sb.from('products').select('id,title,description,price_cents,currency').eq('id',id).maybeSingle();
  if(error||!p){box.innerHTML='<div class="muted">Товар не найден</div>';return;}
  const {data:file}=await sb.from('product_files').select('url,kind').eq('product_id',id).eq('kind','cover').maybeSingle();
  const cover=file?.url||'';
  box.innerHTML=`<div class="panel"><div class="thumb" style="background-image:url('${cover}')"></div></div>
  <div class="panel" style="padding:14px"><h1>${escapeHtml(p.title)}</h1>
  <div class="muted" style="margin-bottom:10px">${escapeHtml(p.description||'')}</div>
  <div style="font-weight:900;margin:10px 0">${price(p.price_cents,p.currency)}</div>
  <button class="btn" id="buy">Купить</button>
  <div class="muted" style="font-size:.9rem;margin-top:6px">Цифровой товар: файл доступен после оплаты.</div></div>`;
  document.getElementById('buy').onclick=()=>alert('Покупка будет позже (плейсхолдер).');
})();
</script>
</body>
</html>


